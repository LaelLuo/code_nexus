# CodeNexus 数据存储设计

## 1. 存储架构概述

### 1.1 混合存储策略

CodeNexus 采用 JSON + SQLite 混合存储架构，充分发挥两种存储方式的优势：

- **JSON 文件**：存储业务数据，便于版本控制和人工查看
- **SQLite 数据库**：提供高效的索引和查询能力
- **内存缓存**：优化频繁访问的数据性能

### 1.2 目录结构

```
project_root/
├── .codenexus/
│   ├── data/
│   │   └── metadata.json        # 统一元数据文件
│   ├── database/
│   │   ├── search_index.db      # 搜索索引（本地重建）
│   │   └── cache.db             # 缓存数据（不纳入版本控制）
│   ├── config/
│   │   └── project.toml         # 项目配置
│   └── logs/
│       └── codenexus.log        # 操作日志
├── .gitignore                   # 排除缓存和日志
└── README.md
```

### 1.3 存储分工

**JSON 存储职责**
- 文件元数据（标签、注释、关系）
- 全局配置信息
- 用户自定义数据结构

**SQLite 存储职责**
- 全文搜索索引
- 查询性能优化
- 统计数据缓存
- 临时计算结果

**文件系统职责**
- 源代码文件管理
- 配置文件存储
- 日志文件记录

## 2. JSON 数据结构设计

### 2.1 统一元数据文件

**文件路径**：`.codenexus/data/metadata.json`

```json
{
  "version": "1.0",
  "last_updated": "2025-07-01T15:30:00Z",
  "project_info": {
    "name": "CodeNexus",
    "description": "代码库关系管理工具",
    "created_at": "2025-07-01T10:00:00Z"
  },
  "files": {
    "src/main.rs": {
      "hash": "sha256:abc123...",
      "tags": ["backend", "core"],
      "comment": "主入口文件，包含应用启动逻辑",
      "relationships": [
        {
          "target": "src/lib.rs",
          "type": "imports",
          "description": "导入核心库函数"
        }
      ],
      "updated_at": "2025-07-01T15:30:00Z"
    },
    "src/lib.rs": {
      "hash": "sha256:def456...",
      "tags": ["backend", "library"],
      "comment": "核心库文件，提供主要功能",
      "relationships": [
        {
          "target": "src/config.rs", 
          "type": "imports",
          "description": "导入配置模块"
        }
      ],
      "updated_at": "2025-07-01T14:20:00Z"
    }
  },
  "global_tags": {
    "backend": {
      "description": "后端相关文件",
      "color": "#ff6b6b",
      "created_at": "2025-07-01T10:00:00Z"
    },
    "core": {
      "description": "核心功能文件", 
      "color": "#4ecdc4",
      "created_at": "2025-07-01T10:00:00Z"
    }
  },
  "relationship_types": {
    "imports": {
      "description": "导入关系",
      "bidirectional": false
    },
    "calls": {
      "description": "调用关系",
      "bidirectional": false
    },
    "configures": {
      "description": "配置关系",
      "bidirectional": true
    },
    "depends_on": {
      "description": "依赖关系",
      "bidirectional": false
    }
  }
}
```

### 2.2 数据结构说明

**文件元数据结构**
- `hash`：文件内容的 SHA256 哈希值，用于检测文件变更
- `tags`：文件标签数组，支持多标签分类
- `comment`：文件注释，支持 Markdown 格式
- `relationships`：文件关系数组，记录与其他文件的关联
- `updated_at`：最后更新时间戳

**全局标签定义**
- `description`：标签的详细描述
- `color`：标签的显示颜色（十六进制）
- `created_at`：标签创建时间

**关系类型定义**
- `description`：关系类型的说明
- `bidirectional`：是否为双向关系

### 2.3 数据验证规则

**文件路径规范**
- 使用相对路径，以项目根目录为基准
- 路径分隔符统一使用正斜杠 `/`
- 不允许包含特殊字符和空格

**标签命名规范**
- 只允许字母、数字、下划线和连字符
- 长度限制在 2-50 个字符之间
- 不区分大小写，统一转换为小写

**关系验证规则**
- 目标文件必须存在于文件列表中
- 不允许自引用关系
- 相同类型的关系不允许重复

## 3. SQLite 索引设计

### 3.1 搜索索引表结构

```sql
-- 文件全文搜索索引
CREATE VIRTUAL TABLE file_search USING fts5(
    file_path,
    tags,
    comment,
    content='',
    content_rowid='rowid'
);

-- 标签索引表
CREATE TABLE tag_index (
    id INTEGER PRIMARY KEY,
    tag_name TEXT NOT NULL,
    file_path TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(tag_name, file_path)
);

-- 关系索引表
CREATE TABLE relationship_index (
    id INTEGER PRIMARY KEY,
    source_path TEXT NOT NULL,
    target_path TEXT NOT NULL,
    relationship_type TEXT NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(source_path, target_path, relationship_type)
);

-- 统计缓存表
CREATE TABLE stats_cache (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 索引维护策略

**增量更新**
- 监听 JSON 文件变更
- 仅更新变化的索引项
- 批量处理提高性能

**定期重建**
- 每日自动重建索引
- 检测并修复索引不一致
- 清理过期的缓存数据

**性能优化**
- 使用 FTS5 全文搜索引擎
- 创建复合索引优化查询
- 实现查询结果缓存

## 4. 版本控制策略

### 4.1 Git 集成方案

**纳入版本控制的文件**
```gitignore
# 包含在版本控制中
.codenexus/data/metadata.json
.codenexus/config/project.toml

# 排除在版本控制外
.codenexus/database/
.codenexus/logs/
.codenexus/temp/
```

**Git 属性配置**
```gitattributes
# .gitattributes
.codenexus/data/metadata.json merge=codenexus-json
```

### 4.2 单文件存储优势

**减少合并冲突**
- 只有一个 JSON 文件需要处理冲突
- Git 的三路合并算法更有效
- 冲突解决更加直观

**原子性保证**
- 整个数据集的一致性更容易维护
- 避免部分更新导致的数据不一致
- 事务性操作更简单

**简化管理**
- 不需要管理多个分散的文件
- 备份和恢复更加简单
- 数据迁移更加方便

### 4.3 数据备份策略

**自动备份**
```bash
# 每日备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d)
cp .codenexus/data/metadata.json .codenexus/backups/metadata_$DATE.json
```

**版本历史**
- 利用 Git 历史记录数据变更
- 支持回滚到任意历史版本
- 提供数据变更审计功能

**导出导入**
- 支持 JSON 格式的数据导出
- 提供数据导入验证功能
- 支持跨项目的数据迁移

## 5. 性能优化

### 5.1 缓存策略

**内存缓存**
- 缓存频繁访问的文件元数据
- 使用 LRU 算法管理缓存空间
- 设置合理的缓存过期时间

**查询缓存**
- 缓存复杂查询的结果
- 支持参数化查询缓存
- 智能缓存失效机制

**索引缓存**
- 缓存热点数据的索引
- 预加载常用查询的索引
- 异步更新索引缓存

### 5.2 I/O 优化

**批量操作**
- 合并多个小的写操作
- 使用事务减少磁盘 I/O
- 异步处理非关键操作

**文件监控**
- 使用文件系统事件监听
- 避免轮询检查文件变更
- 智能过滤无关文件变更

**延迟加载**
- 按需加载文件元数据
- 分页加载大量数据
- 预测性数据预加载

### 5.3 查询优化

**索引优化**
- 为常用查询创建专用索引
- 使用复合索引优化多条件查询
- 定期分析和优化索引性能

**查询重写**
- 自动优化复杂查询
- 使用查询计划缓存
- 支持查询提示和优化建议

**结果缓存**
- 缓存查询结果集
- 支持增量结果更新
- 智能缓存失效策略

---

**相关文档**：
- [技术架构](./技术架构.md) - 了解整体架构设计
- [协作方案](./协作方案.md) - 查看多人协作机制
- [MCP接口规范](./MCP接口规范.md) - 了解数据访问接口

**文档版本**：v2.0  
**创建日期**：2025-07-01  
**最后更新**：2025-07-01
