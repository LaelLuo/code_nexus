# CodeNexus 数据层实现计划

## 📖 文档概述

本文档详细规划了 CodeNexus 数据层的实现计划，包括 JSON 存储、SQLite 索引、缓存机制和数据同步等核心组件的开发任务。数据层是整个系统的基础，为上层业务逻辑提供可靠的数据存储和高效的查询能力。

## 🎯 实现目标

- 建立稳定可靠的混合存储架构（JSON + SQLite）
- 实现高效的数据索引和查询机制
- 提供完善的缓存策略优化性能
- 确保数据一致性和版本控制兼容性

## 📋 详细实现计划

### 🏗️ 阶段一：基础存储架构

#### 1.1 项目目录结构初始化
- [ ] **创建 .codenexus 目录结构**
  - 实现目录自动创建逻辑
  - 设置合适的文件权限
  - 添加 .gitignore 规则配置
  - 依赖：无

- [ ] **实现配置文件管理**
  - 创建 project.toml 配置文件结构
  - 实现配置读取和写入功能
  - 添加配置验证和默认值处理
  - 依赖：目录结构初始化

#### 1.2 JSON 存储层实现
- [ ] **设计 metadata.json 数据结构**
  - 定义文件元数据的 JSON Schema
  - 实现标签、注释、关系的数据模型
  - 添加版本信息和时间戳字段
  - 依赖：无

- [ ] **实现 JSON 文件操作**
  - 创建 JsonStorage 结构体和方法
  - 实现原子性写入操作（临时文件 + 重命名）
  - 添加 JSON 格式验证和错误处理
  - 实现增量更新机制
  - 依赖：数据结构设计

- [ ] **实现数据序列化和反序列化**
  - 使用 serde_json 实现数据转换
  - 添加自定义序列化器处理特殊字段
  - 实现向后兼容的数据迁移逻辑
  - 依赖：JSON 文件操作

### 🗄️ 阶段二：SQLite 索引层

#### 2.1 数据库架构设计
- [ ] **设计索引数据库表结构**
  - 创建文件索引表（files）
  - 创建标签索引表（tags）
  - 创建关系索引表（relationships）
  - 创建全文搜索索引表（search_index）
  - 依赖：JSON 数据结构

- [ ] **实现数据库连接管理**
  - 创建 SqliteIndex 结构体
  - 实现连接池和事务管理
  - 添加数据库初始化和迁移逻辑
  - 设置合适的 SQLite 配置参数
  - 依赖：表结构设计

#### 2.2 索引同步机制
- [ ] **实现 JSON 到 SQLite 的数据同步**
  - 创建数据同步服务
  - 实现增量同步算法
  - 添加数据一致性检查
  - 处理同步冲突和错误恢复
  - 依赖：数据库连接管理、JSON 存储层

- [ ] **实现索引重建功能**
  - 创建完整索引重建流程
  - 实现并发安全的重建机制
  - 添加重建进度跟踪
  - 提供索引验证和修复功能
  - 依赖：数据同步机制

### ⚡ 阶段三：缓存机制

#### 3.1 内存缓存实现
- [ ] **设计缓存架构**
  - 选择合适的缓存库（如 moka）
  - 设计缓存键值策略
  - 实现 LRU 缓存淘汰机制
  - 添加缓存统计和监控
  - 依赖：无

- [ ] **实现缓存操作接口**
  - 创建 CacheManager 结构体
  - 实现缓存的增删改查操作
  - 添加缓存失效和更新机制
  - 实现缓存预热功能
  - 依赖：缓存架构设计

#### 3.2 缓存策略优化
- [ ] **实现智能缓存策略**
  - 根据访问频率调整缓存优先级
  - 实现查询结果缓存
  - 添加缓存命中率统计
  - 优化缓存大小和过期时间
  - 依赖：缓存操作接口

### 🔄 阶段四：数据一致性保证

#### 4.1 事务管理
- [ ] **实现数据操作事务**
  - 设计事务接口和实现
  - 确保 JSON 和 SQLite 的一致性
  - 实现回滚和错误恢复机制
  - 添加事务日志记录
  - 依赖：JSON 存储层、SQLite 索引层

#### 4.2 并发控制
- [ ] **实现读写锁机制**
  - 使用 Rust 的 RwLock 保护共享数据
  - 实现细粒度锁定策略
  - 避免死锁和竞态条件
  - 优化并发性能
  - 依赖：事务管理

### 📊 阶段五：查询引擎基础

#### 5.1 查询接口设计
- [ ] **设计统一查询接口**
  - 创建 QueryEngine trait
  - 定义查询参数和结果结构
  - 实现基础查询操作（按文件、标签、关系）
  - 添加查询结果分页和排序
  - 依赖：SQLite 索引层

- [ ] **实现全文搜索功能**
  - 集成 SQLite FTS5 扩展
  - 实现中文分词和搜索
  - 添加搜索结果高亮
  - 优化搜索性能
  - 依赖：查询接口设计

## 🏁 里程碑规划

### 里程碑 1：基础存储（第1-2周）
- ✅ 完成项目目录结构和配置管理
- ✅ 实现 JSON 存储层基础功能
- ✅ 建立 SQLite 数据库架构

### 里程碑 2：索引同步（第3-4周）
- ✅ 完成数据同步机制
- ✅ 实现索引重建功能
- ✅ 建立数据一致性保证

### 里程碑 3：缓存优化（第5周）
- ✅ 实现内存缓存机制
- ✅ 完成缓存策略优化
- ✅ 集成并发控制

### 里程碑 4：查询基础（第6周）
- ✅ 完成查询引擎基础架构
- ✅ 实现全文搜索功能
- ✅ 性能测试和优化

## 🔗 技术实现要点

### JSON 存储优化
- 使用原子性写入避免数据损坏
- 实现 JSON 格式的美化输出便于版本控制
- 添加数据压缩减少存储空间

### SQLite 性能优化
- 合理设计索引提高查询效率
- 使用 WAL 模式提高并发性能
- 定期执行 VACUUM 优化数据库

### 缓存策略
- 缓存热点数据和查询结果
- 实现缓存预热和智能淘汰
- 监控缓存命中率和性能指标

## 🧭 相关文档导航

- **上级文档**：[设计文档 - 数据存储设计](../design/数据存储设计.md)
- **下级文档**：[核心功能实现计划](./核心功能实现计划.md)
- **并行文档**：[测试计划](./测试计划.md)
- **总览文档**：[实现计划导航](./README.md)

---

**文档版本**：v1.0  
**创建日期**：2025-07-01  
**最后更新**：2025-07-01
